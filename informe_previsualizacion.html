<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>    
    <title>Previsualización del Informe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
        }
        .images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .images-container img {
            max-width: 200px;
            border: 1px solid #ccc;
            padding: 5px;
        }
        .button-container {
            text-align: center;
            margin-bottom: 50px;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
        }
        .footer-text {
            text-align: center;
            font-size: 14px;
            margin-top: 50px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container" id="informeContent">
        <h1>Informe de Ecografía</h1>

        <div class="section" id="datosPacienteSection">
            <h2>Datos del Paciente</h2>
            <p><strong>Historia Clínica:</strong> <span id="historiaClinica"></span></p>
            <p><strong>Nombre:</strong> <span id="nombrePaciente"></span></p>
            <p><strong>Especie:</strong> <span id="especie"></span></p>
            <p><strong>Edad:</strong> <span id="edad"></span></p>
            <p><strong>Sexo:</strong> <span id="sexo"></span></p>
            <p><strong>Tipo de Ecografía:</strong> <span id="tipoEco"></span></p>
        </div>

        <div class="section" id="observacionesSection">
            <h2>Observaciones por Región</h2>
            <div id="observacionesContainer"></div>
        </div>

        <div class="section" id="imagenesSection">
            <h2>Imágenes</h2>
            <div class="images-container" id="imagenesContainer"></div>
        </div>

        <div class="section" id="conclusionesSection">
            <h2>Conclusiones y Recomendaciones</h2>
            <p><strong>Conclusiones:</strong> <span id="conclusiones"></span></p>
            <p><strong>Recomendaciones:</strong> <span id="recomendaciones"></span></p>
        </div>
    </div>

    <div class="button-container">
        <button id="btnGenerarPDF">Generar PDF</button>
    </div>

    <div class="footer-text">
        <p>Al finalizar la generación de PDF, se dará por concluida la exploración.</p>
    </div>

    <!-- Librerías html2canvas y jsPDF desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Cargamos datos desde sessionStorage
            const historiaClinica = sessionStorage.getItem("historiaClinica") || "";
            const nombrePaciente = sessionStorage.getItem("nombrePaciente") || "";
            const especie = sessionStorage.getItem("especie") || "";
            const edad = sessionStorage.getItem("edad") || "";
            const sexo = sessionStorage.getItem("sexo") || "";
            const tipoEco = sessionStorage.getItem("tipoEco") || "";
            
            const observaciones = JSON.parse(sessionStorage.getItem("observaciones")) || []; 
            // observaciones se espera que sea un array de objetos { region: "texto", observacion: "textoObservacion" }

            const imagenes = JSON.parse(sessionStorage.getItem("imagenes")) || []; 
            // imagenes se espera que sea un array de strings base64

            const conclusionesText = sessionStorage.getItem("conclusiones") || "";
            const recomendacionesText = sessionStorage.getItem("recomendaciones") || "";

            // Insertar datos en el DOM
            document.getElementById("historiaClinica").textContent = historiaClinica;
            document.getElementById("nombrePaciente").textContent = nombrePaciente;
            document.getElementById("especie").textContent = especie;
            document.getElementById("edad").textContent = edad;
            document.getElementById("sexo").textContent = sexo;
            document.getElementById("tipoEco").textContent = tipoEco;

            const obsContainer = document.getElementById("observacionesContainer");
            observaciones.forEach(obs => {
                const div = document.createElement("div");
                div.innerHTML = `<p><strong>Región:</strong> ${obs.region}</p>
                                 <p><strong>Observaciones:</strong> ${obs.observacion}</p>
                                 <hr>`;
                obsContainer.appendChild(div);
            });

            const imgContainer = document.getElementById("imagenesContainer");
            imagenes.forEach(imgData => {
                const imgEl = document.createElement("img");
                imgEl.src = imgData;
                imgContainer.appendChild(imgEl);
            });

            document.getElementById("conclusiones").textContent = conclusionesText;
            document.getElementById("recomendaciones").textContent = recomendacionesText;

            // Función para generar el PDF
            document.getElementById("btnGenerarPDF").addEventListener("click", async function () {
                const { jsPDF } = window.jspdf;

                // Tomar captura del contenido del informe
                const informeContent = document.getElementById("informeContent");
                const canvas = await html2canvas(informeContent, { scale: 2 });
                const imgData = canvas.toDataURL("image/png");

                // Crear PDF
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                // Ajustar imagen al ancho de la página
                const imgProps = pdf.getImageProperties(imgData);
                const imgRatio = imgProps.width / imgProps.height;
                let imgHeight = pdfWidth / imgRatio;
                if (imgHeight > pdfHeight) {
                    // Si la imagen es más alta que una página, podemos escalarla
                    imgHeight = pdfHeight;
                }

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                
                // Guardar el PDF
                pdf.save(`Informe_${nombrePaciente}_${historiaClinica}.pdf`);

                // Tras guardar, podemos limpiar sessionStorage y redirigir a landing
                sessionStorage.clear();
                window.location.href = "landing.html";
            });
        });
    </script>
</body>
</html>
